nohup: ignoring input
[0;34m
==========================================
Lightning Prediction Model Pipeline
==========================================
[0m
[0;34m==== Validating Input Files and Directories ====[0m
[0;32mâœ“ All input validation passed[0m
[0;34m==== Setting Up Directory Structure ====[0m
[0;32mâœ“ Directory structure ready[0m
[0;34m==== Setting Up Monitoring ====[0m
Tensorboard is available. To monitor training, run:
  tensorboard --logdir logs

Log locations:
  Training logs: logs/
  Experiment logs: experiments/lightning_cape_seasonal_20250709_134815/logs/
  Checkpoints: experiments/lightning_cape_seasonal_20250709_134815/checkpoints/
[1;33mâš  Skipping data preprocessing[0m
[0;34m==== Training Lightning Prediction Model ====[0m
Experiment name: lightning_cape_seasonal_20250709_134815
Configuration: config

[0;32mâœ“ GPU detected - training will use CUDA[0m
NVIDIA GeForce RTX 3070 Laptop GPU, 8192

Seed set to 42
2025-07-09 13:48:18,110 - __main__ - INFO - Loaded configuration from config
2025-07-09 13:48:18,127 - __main__ - INFO - Configuration validation completed
2025-07-09 13:48:18,127 - __main__ - INFO - Created directories for experiment: lightning_cape_seasonal_20250709_134815
2025-07-09 13:48:18,133 - __main__ - INFO - Saved experiment configuration to experiments/lightning_cape_seasonal_20250709_134815/config.yaml
2025-07-09 13:48:18,133 - __main__ - INFO - Initializing data module...
2025-07-09 13:48:18,133 - src.data.data_loader - INFO - Setting up data for stage: fit
2025-07-09 13:48:18,135 - src.data.data_loader - INFO - Loaded 24 train, 4 val, 8 test file pairs
2025-07-09 13:48:18,135 - src.data.data_loader - INFO - Setting up data preprocessor...
2025-07-09 13:48:18,135 - src.data.preprocessing - INFO - Computing normalization statistics for cape
2025-07-09 13:48:18,303 - src.data.preprocessing - INFO - cape normalization stats: {'mean': 582.4618530273438, 'std': 958.6071166992188}
2025-07-09 13:48:18,305 - src.data.preprocessing - INFO - Computing normalization statistics for terrain
2025-07-09 13:48:18,308 - src.data.preprocessing - INFO - terrain normalization stats: {'mean': 248.5579071044922, 'std': 252.46376037597656}
2025-07-09 13:48:18,308 - src.data.data_loader - INFO - CAPE stats: {'mean': 582.4618530273438, 'std': 958.6071166992188}
2025-07-09 13:48:18,308 - src.data.data_loader - INFO - Terrain stats: {'mean': 248.5579071044922, 'std': 252.46376037597656}
2025-07-09 13:48:18,309 - src.data.dataset - INFO - Building dataset sample index...
2025-07-09 13:48:18,462 - src.data.dataset - INFO - Built dataset index with 17592 samples
2025-07-09 13:48:18,462 - src.data.dataset - INFO - Building dataset sample index...
2025-07-09 13:48:18,487 - src.data.dataset - INFO - Built dataset index with 2928 samples
2025-07-09 13:48:18,488 - __main__ - INFO - Data module initialized with 24 train files
2025-07-09 13:48:18,515 - __main__ - INFO - Sample batch shapes:
2025-07-09 13:48:18,515 - __main__ - INFO -   cape: torch.Size([1, 19, 26])
2025-07-09 13:48:18,515 - __main__ - INFO -   terrain: torch.Size([1, 710, 710])
2025-07-09 13:48:18,515 - __main__ - INFO -   lightning: torch.Size([181, 221])
2025-07-09 13:48:18,515 - __main__ - INFO - Creating trainer and model...
/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/lightning_fabric/connector.py:571: `precision=16` is supported for historical reasons but its usage is discouraged. Please set your precision to 16-mixed instead!
Using 16bit Automatic Mixed Precision (AMP)
GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
HPU available: False, using: 0 HPUs
`Trainer(val_check_interval=1.0)` was configured so validation will run at the end of the training epoch..
2025-07-09 13:48:18,635 - __main__ - INFO - Model created:
2025-07-09 13:48:18,635 - __main__ - INFO -   Total parameters: 21,410,851
2025-07-09 13:48:18,635 - __main__ - INFO -   Model size: 81.7 MB
2025-07-09 13:48:18,635 - __main__ - INFO -   CAPE-only mode: True
2025-07-09 13:48:18,635 - __main__ - INFO - Starting training...
2025-07-09 13:48:18,635 - __main__ - INFO - Testing data loading...
2025-07-09 13:48:18,635 - __main__ - INFO - Train dataloader created successfully
2025-07-09 13:48:18,635 - __main__ - INFO - Attempting to get first batch...
   âœ“ Encoders built (CAPE: 256ch, Terrain: 64ch)
   âœ“ Fusion modules built (Output: 512ch)
   âœ“ Core processing built (GNN: 128ch, Transformer: 128ch)
   âœ“ Prediction head built (Output: 1ch)
   âœ“ Domain adaptation built
âœ… Lightning Prediction Model initialized
   - CAPE-only mode: True
   - Domain adaptation: True
   - Physics constraints: True
Lightning Trainer initialized:
  - Model parameters: 21,410,851
  - Gradient accumulation: 8 steps
  - Domain adaptation: True
  - Physics loss weight: 0.1
2025-07-09 13:48:18,830 - __main__ - INFO - First batch loaded successfully
2025-07-09 13:48:18,831 - __main__ - INFO - Batch keys: ['cape', 'terrain', 'lightning', 'file_idx', 'time_start']
2025-07-09 13:48:18,831 - __main__ - INFO -   cape: torch.Size([1, 1, 19, 26]) (torch.float32)
2025-07-09 13:48:18,831 - __main__ - INFO -   terrain: torch.Size([1, 1, 710, 710]) (torch.float32)
2025-07-09 13:48:18,831 - __main__ - INFO -   lightning: torch.Size([1, 181, 221]) (torch.float32)
2025-07-09 13:48:18,831 - __main__ - INFO -   file_idx: torch.Size([1]) (torch.int64)
2025-07-09 13:48:18,831 - __main__ - INFO -   time_start: torch.Size([1]) (torch.int64)
2025-07-09 13:48:18,831 - __main__ - INFO - Testing model forward pass...
2025-07-09 13:48:22,050 - __main__ - INFO - Model forward pass successful
2025-07-09 13:48:22,050 - __main__ - INFO - Output shape: torch.Size([1, 1, 152, 208])
You are using a CUDA device ('NVIDIA GeForce RTX 3070 Laptop GPU') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
2025-07-09 13:48:22,054 - src.data.data_loader - INFO - Preparing data...
2025-07-09 13:48:22,080 - src.data.data_loader - INFO - Setting up data for stage: fit
2025-07-09 13:48:22,082 - src.data.data_loader - INFO - Loaded 24 train, 4 val, 8 test file pairs
2025-07-09 13:48:22,082 - src.data.data_loader - INFO - Setting up data preprocessor...
2025-07-09 13:48:22,082 - src.data.preprocessing - INFO - Computing normalization statistics for cape
2025-07-09 13:48:22,234 - src.data.preprocessing - INFO - cape normalization stats: {'mean': 582.4618530273438, 'std': 958.6071166992188}
2025-07-09 13:48:22,234 - src.data.preprocessing - INFO - Computing normalization statistics for terrain
2025-07-09 13:48:22,238 - src.data.preprocessing - INFO - terrain normalization stats: {'mean': 248.5579071044922, 'std': 252.46376037597656}
2025-07-09 13:48:22,238 - src.data.data_loader - INFO - CAPE stats: {'mean': 582.4618530273438, 'std': 958.6071166992188}
2025-07-09 13:48:22,238 - src.data.data_loader - INFO - Terrain stats: {'mean': 248.5579071044922, 'std': 252.46376037597656}
2025-07-09 13:48:22,238 - src.data.dataset - INFO - Building dataset sample index...
2025-07-09 13:48:22,393 - src.data.dataset - INFO - Built dataset index with 17592 samples
2025-07-09 13:48:22,393 - src.data.dataset - INFO - Building dataset sample index...
2025-07-09 13:48:22,419 - src.data.dataset - INFO - Built dataset index with 2928 samples
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name          | Type               | Params | Mode
------------------------------------------------------------
0 | model         | LightningPredictor | 21.4 M | eval
1 | loss_function | CompositeLoss      | 5      | eval
2 | train_metrics | LightningMetrics   | 0      | eval
3 | val_metrics   | LightningMetrics   | 0      | eval
4 | test_metrics  | LightningMetrics   | 0      | eval
------------------------------------------------------------
21.4 M    Trainable params
0         Non-trainable params
21.4 M    Total params
85.643    Total estimated model params size (MB)
0         Modules in train mode
259       Modules in eval mode
2025-07-09 13:48:22,450 - src.training.trainer - INFO - Computing class weights from training data...
2025-07-09 13:48:28,404 - src.training.trainer - INFO - Computed class weights: tensor([  0.5010, 246.7735])
2025-07-09 13:48:28,436 - src.training.trainer - INFO - Model info: {'total_parameters': 21410851, 'trainable_parameters': 21410851, 'cape_only_mode': True, 'domain_adaptation_enabled': True, 'physics_weight': 0.05, 'model_size_mb': 81.6759147644043, 'components': {'cape_encoder': 256, 'terrain_encoder': 64, 'era5_encoder': 0, 'fusion_output': 512, 'gnn_hidden': 128, 'transformer_hidden': 128, 'prediction_output': 1}}
2025-07-09 13:48:28,436 - src.training.trainer - INFO - Domain adaptation will be enabled after epoch 10
Sanity Checking: |          | 0/? [00:00<?, ?it/s]Sanity Checking:   0%|          | 0/2 [00:00<?, ?it/s]Sanity Checking DataLoader 0:   0%|          | 0/2 [00:00<?, ?it/s]Sanity Checking DataLoader 0:  50%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     | 1/2 [00:00<00:00,  1.32it/s]Sanity Checking DataLoader 0: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 2/2 [00:01<00:00,  1.83it/s]/mnt/scratch/lightning_prediction/./src/training/metrics.py:128: invalid value encountered in cast
/mnt/scratch/lightning_prediction/./src/training/metrics.py:134: Only one class present in targets
2025-07-09 13:48:29,777 - __main__ - ERROR - Training failed with detailed traceback:
2025-07-09 13:48:29,778 - __main__ - ERROR - Traceback (most recent call last):
  File "scripts/train.py", line 230, in main
    trainer.fit(lightning_module, datamodule)
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/trainer.py", line 538, in fit
    call._call_and_handle_interrupt(
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/call.py", line 47, in _call_and_handle_interrupt
    return trainer_fn(*args, **kwargs)
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/trainer.py", line 574, in _fit_impl
    self._run(model, ckpt_path=ckpt_path)
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/trainer.py", line 981, in _run
    results = self._run_stage()
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/trainer.py", line 1023, in _run_stage
    self._run_sanity_check()
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/trainer.py", line 1052, in _run_sanity_check
    val_loop.run()
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/loops/utilities.py", line 178, in _decorator
    return loop_run(self, *args, **kwargs)
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/loops/evaluation_loop.py", line 142, in run
    return self.on_run_end()
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/loops/evaluation_loop.py", line 254, in on_run_end
    self._on_evaluation_epoch_end()
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/loops/evaluation_loop.py", line 334, in _on_evaluation_epoch_end
    call._call_lightning_module_hook(trainer, hook_name)
  File "/home/dev/WRF/miniconda3/envs/lightning-pred/lib/python3.8/site-packages/pytorch_lightning/trainer/call.py", line 167, in _call_lightning_module_hook
    output = fn(*args, **kwargs)
  File "/mnt/scratch/lightning_prediction/./src/training/trainer.py", line 336, in on_validation_epoch_end
    val_metrics = self.val_metrics.compute()
  File "/mnt/scratch/lightning_prediction/./src/training/metrics.py", line 110, in compute
    metrics.update(self._compute_probabilistic_metrics(all_probabilities, all_targets))
  File "/mnt/scratch/lightning_prediction/./src/training/metrics.py", line 194, in _compute_probabilistic_metrics
    'brier_score': np.mean((probabilities - binary_targets) ** 2)
ValueError: operands could not be broadcast together with shapes (63232,) (80002,) 

                                                                           